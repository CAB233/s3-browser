---
import Layout from '../layouts/Layout.astro';
import IndexPage from '../components/IndexPage.astro';
import FourOhFour from '../components/FourOhFour.astro';
import { getBreadcrumb } from '../functions/breadcrumb';
import { listBucket } from '../functions/s3';
import { parseViewParams, sortEntries } from '../functions/sort';

const requestPath = decodeURIComponent(Astro.url.pathname);
const breadCrums = getBreadcrumb(requestPath);
const fsListing = await listBucket(requestPath);
const totalCount = fsListing.numDirectories + fsListing.numFiles;
const title = totalCount > 0 ? `${requestPath}` : '404 - Not Found';
const viewParams = parseViewParams(Astro.url);
const sortedEntries = sortEntries(
  fsListing.entries,
  viewParams.sort,
  viewParams.order,
);
const sortedFsListing = { ...fsListing, entries: sortedEntries };
---

<Layout title={title}>
  {
    (!!totalCount && (
      <IndexPage
        breadCrums={breadCrums}
        fsListing={sortedFsListing}
        requestPath={requestPath}
        viewParams={viewParams}
      />
    )) || <FourOhFour />
  }
</Layout>
